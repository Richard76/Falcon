<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title></title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<script src="libs/navigation-1.1/codefolding.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, target-densityDpi=device-dpi" />
<meta name="format-detection" content="telephone=no" />
<script src="libs/exploratory/resources/jquery.min.js?cb=cb1610313653807"></script>
<script src="libs/exploratory/resources/d3.min.js?cb=cb1610313653807"></script>
<script src="libs/exploratory/resources/chroma.min.js?cb=cb1610313653807"></script>
<script src="libs/exploratory/resources/viz.min.js?cb=cb1610313653807"></script>
<style  type="text/css">
  /* R output adjustment */
  .viz-container img.r-output {
    /* Cancel styles on the R output chart image.*/
    transform: none!IMPORTANT;
    position: initial!IMPORTANT;
    top: initial!IMPORTANT;
    left: initial!IMPORTANT;
  }
</style>
<script src="libs/exploratory/resources/plotly.min.js?cb=cb1610313653807"></script>
<script src="libs/exploratory/resources/plotly-locale-ja.js?cb=cb1610313653807"></script>
<link href="libs/exploratory/resources/plotly-custom.css?cb=cb1610313653807" rel="stylesheet"></link>
<link href="libs/exploratory/resources/pivot.css?cb=cb1610313653807" rel="stylesheet"></link>
<script src="libs/exploratory/resources/jquery.balloon.min.js?cb=cb1610313653807"></script>

<style  type="text/css">
  /* pivot adjustment */
  .pivot-metainfo {
    display:none;
  }
  .viz-container {
   -webkit-font-smoothing: antialiased;
   -moz-osx-font-smoothing: grayscale;
  }
</style>
<script src="libs/exploratory/layout/Bch0Pfe7.js"></script>
<script src="libs/exploratory/layout/bBD4NEr2.js"></script>
<script src="libs/exploratory/layout/yrw8igc4.js"></script>
<script src="libs/exploratory/layout/nsg8jpu3.js"></script>
<script src="libs/exploratory/layout/Zzo1mQY3.js"></script>
<script src="libs/exploratory/layout/YPe3lRG1.js"></script>
<script src="libs/exploratory/layout/dre4zXs6.js"></script>
<script src="libs/exploratory/layout/JbK2CxB9.js"></script>
<script src="libs/exploratory/layout/HBi2JPr4.js"></script>
<script src="libs/exploratory/layout/gJP2UEQ6.js"></script>
<script src="libs/exploratory/layout/KPf0fxr0.js"></script>
<script src="libs/exploratory/layout/KHG1hGM3.js"></script>
<script src="libs/exploratory/layout/lVK1fRJ4.js"></script>
<script src="libs/exploratory/layout/JrV2htm5.js"></script>
<script src="libs/exploratory/layout/oxK7kYZ3.js"></script>
<script src="libs/exploratory/layout/SHn2Gqd6.js"></script>
<script src="libs/exploratory/layout/lcm8sIU3.js"></script>
<script src="libs/exploratory/layout/XWJ6uiV8.js"></script>
<script src="libs/exploratory/layout/wQI8QCa1.js"></script>
<script src="libs/exploratory/layout/Axm6Rfy9.js"></script>
<script src="libs/exploratory/layout/whJ2xDH8.js"></script>
<script src="libs/exploratory/layout/OdL8SnD9.js"></script>
<script src="libs/exploratory/analytics/Wdp6ATm6.js"></script>
<script src="libs/exploratory/analytics/hkX3rQm6.js"></script>
<script src="libs/exploratory/analytics/LGj4EMK7.js"></script>
<script src="libs/exploratory/layout/IQo3CqC1.js"></script>
<script src="libs/exploratory/analytics/GvX2SQK8.js"></script>
<script src="libs/exploratory/analytics/CqL0Omd7.js"></script>




<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="libs/exploratory/resources/note-base.css?cb=20210110T212053753Z" type="text/css" />
<link rel="stylesheet" href="libs/exploratory/resources/note-mobile.css?cb=20210110T212053753Z" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        // adding '_' for the hash. Somehow single word without special chars corrupts the layout.
        return '_'+text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


div.toc-content {
  padding-left: 80px;
  padding-right: 40px;
  max-width:820px; /* 700px (main body width) + padding left/right */ 
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
  div.toc-content {
    padding-left: 40px;
    padding-right: 40px;
    max-width:770px; /* 700px (main body width) + padding left/right */ 
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
  div.toc-content {
    width: 100%;
    padding-left: 15px;
    padding-right: 15px;
    max-width:none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">



<style type="text/css">
/* Styles for plain html output with 2-column layout, which is 
   with TOC floating on the left hand side case.  */ 
.main-container {
}

/* Adjust toc styles */
.tocify-subheader .tocify-item {
  padding-left: 15px;
}
/* h3 and lower headers */
.tocify-subheader .tocify-subheader .tocify-item {
  padding-left: 30px;
}
/* override TOC default top margin */
#TOC {
  margin-top: 48px;
  padding-right:20px;
  color: #444659;
}
@media (max-width: 768px) {
  /* shorter top margin for mobile */
  #TOC { 
    margin-top:25px; padding-right:0px;
  }
}

/* Div surrounding the TOC. */
@media (min-width: 768px) {
  .col-xs-12.col-sm-4.col-md-3 {
    /* Avoid the content overlapping TOC on safari if you zoom out #18209 */
    height: 10px;
  }
}

</style>

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>




</div>


<p>Richard Farr</p>
<p>Falcon Airlines Report</p>
<p>January 2021</p>
<hr />
<div id="executive-summary" class="section level1">
<h1>Executive Summary</h1>
<div id="problem" class="section level2">
<h2>Problem</h2>
<p>Many of Falcon Airlines customers are not satisfied with Falcon Airlines. If things continue this way we will lose customers, lose market share, lose revenues, lose profits, and executives will eventually be let go and replaced with executives willing to tackle problems that result in more satisfied customers, more revenue and a higher stock price.</p>
</div>
<div id="solution" class="section level2">
<h2>Solution</h2>
<p>Of the 4 possible data driven solutions:</p>
<ol style="list-style-type: decimal">
<li>Do nothing and hope things improve</li>
<li>Make changes to Falcon Airlines</li>
<li>Attract new customers more likely to be happy with Falcon Airlines</li>
<li>Do a combination of 3 and 4 above at the same time</li>
</ol>
<p>The data science team recommends a two phase solution.</p>
<p>Phase 1: Make changes to Falcon Airlines in order to make our current customers happier (2)</p>
<p>Phase 2: Change marketing in order to attract new customers that are more likely to be satisfied with Falcon airlines.</p>
<p>We beleive that going after low hanging fruit first and generating momentum is better than biting off more than we can chew and failing.</p>
<p>This report will focus our efforts on Phase 1 and specifically focus on the factors within our control to change in order to improve current customers satisfaction.</p>
<p>The top few factors that are within our control that we should do a cost benefit analysis on are:</p>
<ul>
<li>Seat comfort</li>
<li>Inflight Entertainment</li>
<li>Onboard Service</li>
<li>Cleanliness</li>
<li>Ease of onboarding</li>
<li>Online boarding</li>
<li>Online Support</li>
<li>Checkin Service</li>
<li>Baggage Handling</li>
<li>Inflight Wifi Service</li>
</ul>
<p>Utltimatly we want to attack the low hanging fruit. We want to fix the factors that are fast, easy, and cheap to fix but will result in customers being delighted.</p>
<p>In order to do that we need to estimate what it will cost to a) become above average and b) the best for each factor in relation to our direct competitors.</p>
<p>This report only details one side of the process, the benefet side. The cost and time needed to fix each factor will be the next step.</p>
<hr />
</div>
</div>
<div id="approach" class="section level1">
<h1>Approach</h1>
<div id="understand-the-available-data" class="section level2">
<h2>Understand the available data</h2>
<p>The 2 key datasets consist of:</p>
<ol style="list-style-type: decimal">
<li><p>Flight data - Information about gender, customer type, age, type of traval, class (fare type), flight distance, departure delays, and arrival delays</p></li>
<li><p>Survey data - These are all the survey questions we asked the customers on their flights about their flights.</p></li>
</ol>
<p>The actual flight data, survey data and data dictionary are linked to in the appendix.</p>
</div>
<div id="import-data" class="section level2">
<h2>Import Data</h2>
<p>Both datasets are small enough to import and open using a laptop computer. It is relatively easy to combine the 2 data files into one larger data file using the Customer ID field.</p>
</div>
<div id="wrangle-data" class="section level2">
<h2>Wrangle Data</h2>
<p>The following steps are commented in the R code referenced in the appendix at the end of the document.</p>
<div id="missing-values" class="section level3">
<h3>Missing Values</h3>
<p>There were columns with missing data and this was resolved. The only column with missing values that was arrival delay and the missing values were replaced with 0. The other colums with missing values were not numeric (like answers to questions such as Type of Travel) and missing values were replaced with &quot;Unknown&quot;. It is possible that the act of not answering a queston conveys valuable information that can be picked up by the models later.</p>
</div>
<div id="column-type" class="section level3">
<h3>Column Type</h3>
<p>Columns with a limited number of possibilities were converted to an R data type with levels. Levels are just a way to order the finite possibilities. For example, rather than order acceptable, excellent, extreemly poor, good, need improvement, and poor alphabetically I reordered them in a way that makes sense to humans from best to worst.</p>
</div>
<div id="feature-engineering" class="section level3">
<h3>Feature Engineering</h3>
<p>Feature engineering is the creation of new columns from existing columns.</p>
<p>There are 2 approaches to doing this.</p>
<p><strong>Approach 1</strong> is manually combining columns mathmatically in a logical way that adds information on some way. For example, I can use the data from the departure delays and arrival delays to calculate if a flight left on time and arrived on time vs left late and arrived late. There are 4 possible scenerios and logically it appears that people that left late and arrived late would be less satisfied.</p>
<p><strong>Approach 2</strong> is setting a computer to test lots and lots of combinations randomly in order to get lucky and find a great feature. This solution gets computationally expensive. If each solution takes one hour (aka $20) of compute and we allow the computer to brute force the solution with 10 columns of predictor data then there are 10! = 10 * 9 * 7 * 6 * 5 * 4 * 3 * 2 * 1 = 3,628,800 hours of compute time to run. We would be dead before the computer solves the problem this way and it would be very expensive.</p>
<p>The compromise it to do some of approach 1 and set a $ budget for approach 2 and see if the computer beats the human.</p>
<p>In this case all the models will end up pretty much saying the same thing. What is going to matter is the cost to fix each one.</p>
</div>
</div>
<div id="vizualize-data" class="section level2">
<h2>Vizualize Data</h2>
<p>Its important to realize that we can not easily change some of these things. For example changing our customers gender will require driving away some customers and attracting new ones. This is possible but it is expensive and will take some time. On the other hand, switching out the cushions on the seats is probably relatively cheap and can be done relatively fast.</p>
<p>It makes sense to attack the things that are fast, cheap, and easy over slow, expensive, and difficult.</p>
<div id="gender" class="section level3">
<h3>Gender</h3>
<script data-id="viz_1" data-object-name="viz_Bch0Pfe7" data-viz="Bch0Pfe7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_1" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>There are slightly more females than males and a higher percentage of females are satisfied than men.</p>
</div>
<div id="customertype" class="section level3">
<h3>CustomerType</h3>
<script data-id="viz_2" data-object-name="viz_bBD4NEr2" data-viz="bBD4NEr2" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_2" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Loyal Customers are more likely to be satisfied than disloyal customers but we can't just press a button to convert them from one to another. This is not easily fixable.</p>
</div>
<div id="typetravel" class="section level3">
<h3>TypeTravel</h3>
<script data-id="viz_3" data-object-name="viz_yrw8igc4" data-viz="yrw8igc4" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_3" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>There about twice as many business travelers as personal travelers. The business travelers are more likely to be satisfied than personal travelers. If we were to adjsut marketing to attract new customers, it may be worth looking into attracting more business travelers. But it will boil down to a cost per aquision vs lifetime customer value problem.</p>
</div>
<div id="class" class="section level3">
<h3>Class</h3>
<script data-id="viz_4" data-object-name="viz_nsg8jpu3" data-viz="nsg8jpu3" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_4" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Most business class travelers are satisfied and most economy passengers are not satisfied.</p>
</div>
<div id="age" class="section level3">
<h3>Age</h3>
<script data-id="viz_5" data-object-name="viz_Zzo1mQY3" data-viz="Zzo1mQY3" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_5" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Over 80% of our customers are between 20 and 60. It appears that Satisfaction increases as customers age from 20 to 60.</p>
</div>
<div id="age-gender" class="section level3">
<h3>Age Gender</h3>
<script data-id="viz_6" data-object-name="viz_YPe3lRG1" data-viz="YPe3lRG1" data-height="full" data-width="normal" data-fit="" ></script><div data-id="viz_6" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Men appear to be less satisfied than women at all age groups.</p>
</div>
<div id="flight_distance" class="section level3">
<h3>Flight_Distance</h3>
<script data-id="viz_7" data-object-name="viz_dre4zXs6" data-viz="dre4zXs6" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_7" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Its interesting to see at short distances most people are satisfied, middle distances they are not satisfied, and longer distances they are satisfied again. But changing our routes to take advantage of this relationship would be insanely expensive and probably not worth doing.</p>
</div>
</div>
<div id="the-next-few-varables-are-all-factors.-its-important-to-note-patterns-that-jump-out." class="section level2">
<h2>The next few varables are all factors. Its important to note patterns that jump out.</h2>
<div id="gate_location" class="section level3">
<h3>Gate_location</h3>
<script data-id="viz_8" data-object-name="viz_JbK2CxB9" data-viz="JbK2CxB9" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_8" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="seat_comfort" class="section level3">
<h3>Seat_comfort</h3>
<script data-id="viz_9" data-object-name="viz_HBi2JPr4" data-viz="HBi2JPr4" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_9" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Hardly anybody thinks we have excellent seats. It seems like this is something relatively easy, fast, and cheap to improve upon compared to other things.</p>
</div>
<div id="departure_arrival_time_convenient" class="section level3">
<h3>Departure_Arrival_time_convenient</h3>
<script data-id="viz_10" data-object-name="viz_gJP2UEQ6" data-viz="gJP2UEQ6" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_10" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="food_drink" class="section level3">
<h3>Food_drink</h3>
<script data-id="viz_11" data-object-name="viz_KPf0fxr0" data-viz="KPf0fxr0" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_11" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>If this turns out the be important to our customers too then its probably a cheap, fast, and easy thing to fix. Low hanging fruit?</p>
</div>
<div id="inflightwifi_service" class="section level3">
<h3>Inflightwifi_service</h3>
<script data-id="viz_12" data-object-name="viz_KHG1hGM3" data-viz="KHG1hGM3" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_12" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>It seems like making the wifi better would be cheap, fast, and easy. If turns out to be important to our customers too then its worth looking into upgrading.</p>
</div>
<div id="online_support" class="section level3">
<h3>Online_support</h3>
<script data-id="viz_13" data-object-name="viz_lVK1fRJ4" data-viz="lVK1fRJ4" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_13" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="ease_of_onlinebooking" class="section level3">
<h3>Ease_of_Onlinebooking</h3>
<script data-id="viz_14" data-object-name="viz_JrV2htm5" data-viz="JrV2htm5" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_14" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="onboard_service" class="section level3">
<h3>Onboard_service</h3>
<script data-id="viz_15" data-object-name="viz_oxK7kYZ3" data-viz="oxK7kYZ3" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_15" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="leg_room_service" class="section level3">
<h3>Leg_room_service</h3>
<script data-id="viz_16" data-object-name="viz_SHn2Gqd6" data-viz="SHn2Gqd6" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_16" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="baggage_handling" class="section level3">
<h3>Baggage_handling</h3>
<script data-id="viz_17" data-object-name="viz_lcm8sIU3" data-viz="lcm8sIU3" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_17" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="checkin_service" class="section level3">
<h3>Checkin_service</h3>
<script data-id="viz_18" data-object-name="viz_XWJ6uiV8" data-viz="XWJ6uiV8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_18" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="cleanliness" class="section level3">
<h3>Cleanliness</h3>
<script data-id="viz_19" data-object-name="viz_wQI8QCa1" data-viz="wQI8QCa1" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_19" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="online_boarding" class="section level3">
<h3>Online_boarding</h3>
<script data-id="viz_20" data-object-name="viz_Axm6Rfy9" data-viz="Axm6Rfy9" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_20" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Whats important above is that we understand what the factors are and have a general understanding of its something we can fix (like seat cusions) or whether its something that will take a lot of time and money to fix like what kind of customers we have now vs appear to be a better fit for us. The latter is a big and slow problem to fix, we are looking for the low hanging fruit here. If that works we can attack the bigger and more expensive problems later.</p>
</div>
</div>
<div id="engineered-features" class="section level2">
<h2>Engineered Features</h2>
<div id="delay_summary" class="section level3">
<h3>delay_summary</h3>
<script data-id="viz_21" data-object-name="viz_whJ2xDH8" data-viz="whJ2xDH8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_21" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>I thought there would be more difference in satisfaction if the plane was late... live and learn! If I had weather data I could somehow guess if the delay was due to weather or us. That may make a difference.</p>
</div>
<div id="age_category" class="section level3">
<h3>Age_category</h3>
<p><script data-id="viz_22" data-object-name="viz_OdL8SnD9" data-viz="OdL8SnD9" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_22" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div> Another chart suggesting older people are more likely to be happy than younger people.</p>
<p>Remember: Just becuase I did not engineer a feature does not mean the computer didn't automagically generate and try that feature later in the automl section and didn't tell us it did.</p>
</div>
</div>
<div id="prepare-the-data-for-modeling" class="section level2">
<h2>Prepare the data for Modeling</h2>
<div id="check-for-normality" class="section level3">
<h3>Check for Normality</h3>
<p>If a numeric distribution is not normally distributed it must be transformed before modleing begins.</p>
</div>
</div>
</div>
<div id="normality-check---summary" class="section level1">
<h1>Normality Check - Summary</h1>
<script data-id="analytics_23" data-object-name="analytics_Wdp6ATm6" data-viz="normality_check_table" data-analysis="Wdp6ATm6" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_23" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Age is normally distributed - No need to alter.</p>
<p>Flight distance is not lets see if it is when we transform it by normalizing it.</p>
<div id="summary" class="section level3">
<h3>Summary</h3>
<script data-id="analytics_24" data-object-name="analytics_hkX3rQm6" data-viz="normality_check_table" data-analysis="hkX3rQm6" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_24" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="q-q-plot" class="section level3">
<h3>Q-Q Plot</h3>
<script data-id="analytics_25" data-object-name="analytics_hkX3rQm6" data-viz="scatter" data-analysis="hkX3rQm6" data-height="full" data-width="normal" data-fit="" ></script><div data-id="analytics_25" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="histogram" class="section level3">
<h3>Histogram</h3>
<script data-id="analytics_26" data-object-name="analytics_hkX3rQm6" data-viz="hist" data-analysis="hkX3rQm6" data-height="full" data-width="normal" data-fit="" ></script><div data-id="analytics_26" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="remove-columns-if-they-are-correlated" class="section level3">
<h3>Remove Columns if they are correlated</h3>
<p>If two columns are highly correlated then one should be removed before modeling. If one column is a customer column and one is a Falcon airlines column I will keep the Falcon airlines column becuase it will represent something that we can change</p>
</div>
<div id="correlation---scatter-matrix" class="section level3">
<h3>Correlation - Scatter Matrix</h3>
<script data-id="analytics_27" data-object-name="analytics_LGj4EMK7" data-viz="scattermatrix" data-analysis="LGj4EMK7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_27" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="correlation---positive-pairs" class="section level3">
<h3>Correlation - Positive Pairs</h3>
<script data-id="analytics_28" data-object-name="analytics_LGj4EMK7" data-viz="table" data-analysis="LGj4EMK7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_28" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="correlation---negative-pairs" class="section level3">
<h3>Correlation - Negative Pairs</h3>
<script data-id="analytics_29" data-object-name="analytics_LGj4EMK7" data-viz="negative_table" data-analysis="LGj4EMK7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_29" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Arrival Delay and Departure delay are correlated as expected. That means that we pick one of the two to go into the model or use both to create a new variable that goes into the model. I choose to combine the 2 into a new variable called delay summary.</p>
</div>
<div id="delay_summary-graph" class="section level3">
<h3>delay_summary graph</h3>
<script data-id="viz_30" data-object-name="viz_whJ2xDH8" data-viz="whJ2xDH8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_30" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="model-data" class="section level2">
<h2>Model Data</h2>
<p>As the big picture objective is to make changes to falcon airlines in order to make our</p>
</div>
</div>
<div id="satisfaction" class="section level1">
<h1>Satisfaction</h1>
<script data-id="viz_31" data-object-name="viz_IQo3CqC1" data-viz="IQo3CqC1" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="viz_31" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>Note: 49,761 / (49,761 + 41,156) = 54.7% of our customers are satisfied. This is important for determing cutoffs in the models.</p>
<div id="general-process" class="section level4">
<h4>General Process</h4>
<ol style="list-style-type: decimal">
<li>Break data into 80% training and 20% Testing Set</li>
<li>Use the training data to build a model</li>
<li>Adjust cutoffs so that we predict approximately the same percent of satisfied customers</li>
<li>Check the confusion matrix to see if the predicions are any good.</li>
</ol>
</div>
<div id="approach-1---a-simple-decision-tree" class="section level3">
<h3>Approach 1 - A simple decision tree</h3>
<div id="summary-statistics" class="section level4">
<h4>Summary Statistics</h4>
<script data-id="analytics_32" data-object-name="analytics_GvX2SQK8" data-viz="summary_table" data-analysis="GvX2SQK8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_32" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>The decision tree has an accuracy of about 86.7% on the test dataset.</p>
</div>
<div id="decision-tree---prediction-matrix" class="section level4">
<h4>Decision Tree - Prediction Matrix</h4>
<script data-id="analytics_33" data-object-name="analytics_GvX2SQK8" data-viz="confusion_matrix" data-analysis="GvX2SQK8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_33" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>The decision tree predicts about 56% satisfaction on the test dataset. I accomplished this by adjusting the cutoffs.</p>
</div>
<div id="decision-tree---visualized" class="section level4">
<h4>Decision Tree - Visualized</h4>
<script data-id="analytics_34" data-object-name="analytics_GvX2SQK8" data-viz="tree" data-analysis="GvX2SQK8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_34" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
</div>
<div id="decision-tree---importance" class="section level3">
<h3>Decision Tree - Importance</h3>
<script data-id="analytics_35" data-object-name="analytics_GvX2SQK8" data-viz="feature_importance_bar" data-analysis="GvX2SQK8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_35" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>According to the vizualaization the most important variables for customer satisfaction are inflight entertainment, seat comfort, online support and ease of onboarding.</p>
</div>
<div id="approach-2---a-random-forest" class="section level3">
<h3>Approach 2 - A Random Forest</h3>
<div id="summary-statistics-1" class="section level4">
<h4>Summary Statistics</h4>
<script data-id="analytics_36" data-object-name="analytics_CqL0Omd7" data-viz="summary_table" data-analysis="CqL0Omd7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_36" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="pred.-matrix" class="section level4">
<h4>Pred. Matrix</h4>
<script data-id="analytics_37" data-object-name="analytics_CqL0Omd7" data-viz="confusion_matrix" data-analysis="CqL0Omd7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_37" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
</div>
<div id="importance" class="section level4">
<h4>Importance</h4>
<script data-id="analytics_38" data-object-name="analytics_CqL0Omd7" data-viz="feature_importance_bar" data-analysis="CqL0Omd7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_38" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div>
<p>The random forest model says that the most important variables are seat comfort, inflight entertainment, ease of onboarding, class, &amp; online booking.</p>
<p>Thats good becuase it has lots of overlap to the previous decision tree model.</p>
</div>
</div>
<div id="approach-3---automl-cloud-compute-using-rapidminer-go" class="section level3">
<h3>Approach 3 - AutoML Cloud compute using Rapidminer Go</h3>
<p>In previous reports I used both Rapidminer Go and Google AutoML Tables. Based on experience, I believe that using Rapidminer Go is better for this smaller data problem due to savings in time and compute cost. If we were dealing with a much larger dataset I would request authorization to spend money on Google cloud compute but as the problem is solvable in Rapidminer Go I am going to use rapidminer go for the AutoML.</p>
<div id="model-canidates" class="section level4">
<h4>Model Canidates</h4>
<p>In approach 1 and 2 I just ran one model each for a total of 2 candidates. Rapidminer Go took the cleaned data and built lots of different models using a bigger and faster processor than my computer has.</p>
<p>It took about 3 hours to generate all the models but here are the results.</p>
<div class="figure">
<img src="libs/exploratory/images/p1.png" />

</div>
<p>The gradient boosted trees model was the most accurate and also performed best or near the best for most of the metrics.</p>
<div class="figure">
<img src="libs/exploratory/images/p2.png" />

</div>
<p>The confusion matrix for the gradient boosted trees model predicted (416 + 9392) / ((7487 + 561) + 416 + 9392) = 9808 / 17856 = 54.9% to be satisfied. Which is good. It appears that Rapidminer Go automatically adjusts the cutoffs so that the percentage predicted is approximately what you would expect.</p>
<p>This is just another data point suggesting that we can predict which people will be satisfied relatively well.</p>
<p>Here are the relative importance of the predictors for the gradient boosted trees model.</p>
<div class="figure">
<img src="libs/exploratory/images/p3.png" />

</div>
<p>In general the top 10 predictors have a lot of overlap with the other models.</p>
<p>Ultimately we care that the models are pretty consistant and they suggest that the same columns are important.</p>
<div class="figure">
<img src="libs/exploratory/images/p4.png" />

</div>
</div>
</div>
<div id="key-drivers-of-customer-satisfaction" class="section level2">
<h2>Key Drivers of customer satisfaction</h2>
<p>To summarize, all 3 methods produced pretty good results and in this use case it really doesnt matter what the best model is. All that matters is whether the models say the same things are important.</p>
<p>Lets take a look.</p>
<p>Decision Tree <script data-id="analytics_39" data-object-name="analytics_GvX2SQK8" data-viz="feature_importance_bar" data-analysis="GvX2SQK8" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_39" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div></p>
<p>Random Forrest <script data-id="analytics_40" data-object-name="analytics_CqL0Omd7" data-viz="feature_importance_bar" data-analysis="CqL0Omd7" data-height="normal" data-width="normal" data-fit="" ></script><div data-id="analytics_40" style="width:100%; height:400px; display:table;margin-bottom:38px" class="viz-rendering-error viz-loading"><div style="width:100%; height:100%; display:table-cell; vertical-align:middle; text-align:center; font-size:14px; color:#999; background-color:white;font-family:sans-serif "><div>Loading... </div></div></div></p>
<p>Gradient Boosted Tree <img src="libs/exploratory/images/p5.png" /></p>
<p>All the models tell us that the same few factors are important. That is a good thing.</p>
<hr />
</div>
</div>
<div id="recommendations" class="section level1">
<h1>Recommendations</h1>
<p>To accomplish the goal of making changes to Falcon airlines to make our current customers happier here is what we should go with a low hanging fruit approach.</p>
<p>Step 1: Take the top 10 or so important factors that we can actually do something about. They are:</p>
<ul>
<li>Seat comfort</li>
<li>Inflight Entertainment</li>
<li>Onboard Service</li>
<li>Cleanliness</li>
<li>Ease of onboarding</li>
<li>Online boarding</li>
<li>Online Support</li>
<li>Checkin Service</li>
<li>Baggage Handling</li>
<li>Inflight Wifi Service</li>
</ul>
<p>Step 2: Estimate how much each one would cost to improve. For example, what would it cost to upgrade so that we are average compared to our competitors? What would the cost be to upgrade to become the best at this?</p>
<p>Step 3: Spend the money that gets us the most bank for the buck, aka the higest expected ROI. If something is really important to our customers and its really cheap to do then we should do that first.</p>
<p>This is a cost benefit analysis. We know the benefits of making our customers happier, the next step, if we choose to continue, is to figure out the costs.</p>
<p>At that point its possible to make a decison.</p>
<hr />
</div>
<div id="appendix" class="section level1">
<h1>Appendix</h1>
<ol style="list-style-type: decimal">
<li>Data Dictionary</li>
<li>Flight Data</li>
<li>Survey Data</li>
<li>Data Wrangling Steps - R Code</li>
<li>Wrangled Dataset - RDS File</li>
<li><a href="https://github.com/Richard76/Falcon">Github Repository</a></li>
</ol>
</div>

<!-- BEGIN: Exploratory custom footer -->

<script>

var FULL_WIDTH_MARGIN_SIDE = 60;
var $body = $(document.body);
var screenWidth = $body.width();
var openInDesktop = window.location.href.indexOf("desktop=true") > -1; 

// The default body max-width is set to 782px so if it is less than 902px 
// (782 + 60 left margin + 60 right margin) we cancel stretching images. 
$('img[width="full"]').each(function() {
  var $elem = $(this);
  if (screenWidth > 902) {
    $elem.attr("width", "");  // remove "full"
    var elemOffsetLeft = $elem.offset().left;
    $elem.css({"width": (screenWidth - (FULL_WIDTH_MARGIN_SIDE*2) )+'px', "max-width": (screenWidth - (FULL_WIDTH_MARGIN_SIDE*2) )+'px', "margin-left": (-1 *(elemOffsetLeft - FULL_WIDTH_MARGIN_SIDE)) + "px" });
  } else {
    $elem.attr("width", "100%"); // replace "full" with "100%"
  }
});

$('a').each(function(index, a){
  var $link = $(this);
  if($link.attr('href') && !$link.attr('href').startsWith('file')){// tab has a with href="file" so exclude tab
    $link.attr('target','_blank'); // make sure link opens another tab or window.
  }
});

var enableLinks = function() {
  if (!openInDesktop) {
    return false;
  }
  $('a').each(function(index, a){
    var $link = $(this);
    // Enable links starting with http* and mailto. Others are used for 
    // other purpose such as map, tab, etc so don't touch those. 
    if($link.attr('href') && /^(http:\/\/|https:\/\/|mailto:)/.test($link.attr('href'))){
      $link.off("click");
      $link.on("click", function (e) {
        e.preventDefault(); // make sure to block default to avoid external content rendered inside Exploratory Desktop.
        window.parent.postMessage(JSON.stringify({action:'OpenExternalLink', url: $link.attr('href')}),'*');
        //MarkdownActions.openExternalLink($link.attr('href'));
      });
    }
  });
};

var onMessageReceiveHandler = function(event){
  var data = null;   
  try {
    data = JSON.parse(event.data);
  } catch(e) {
    // The event.data may be just a text like 'ready'. 
    // We ignore those cases. 
  }
  if (!data) {
    return;
  }
  if(data.action) {
    switch(data.action) {
      case "ScrollY":
        window.scrollTo(0, data.scrollY);
        break;
      case "EnableLinks":
        enableLinks();
        break;
    }
  }

}
window.addEventListener('message', onMessageReceiveHandler, false); 

var ready = function(){
  window.parent.postMessage(JSON.stringify({action:'DocumentReady'}),'*');
}
document.addEventListener("DOMContentLoaded", ready);

</script>

<script>


// Find exploratory vizs
var $vizs = $("script[data-id]");
// View area width. 
var screenWidth = $(document.body).width();
// View area height. 
var screenHeight = $(window).height();

// In case of shared note, the note is loaded in the iframe so the screen
// height is shorter than the actual screen size so we need to adjust it.
// Accessing the parent fails if you open it locally (including opening on desktop) 
// because of the cross origin so just to check. 
if (!/^file:/.test(window.location.href)) {
  var offset = $(window.parent.document).find("iframe.markdown-content-frame").offset();
  if (offset && offset.top) {
    screenHeight+=offset.top;
  }
}

// Capturing charts/analytics snapshot images for Word output and 
// self-contained HTML output.  (self-contained HTML output is not used now.)
var _generateSnapshot = function() {
  var $elem = $(this); // this <a> tag
  var id = $elem.attr("data-id").replace(/^a\-/, "");
  var objectName = $elem.attr("data-object-name");
  var analyticsName = null;

  var viz = window[objectName];
  if (!window._datauris) 
    window._datauris = {};
  
  // If it is analytics, find the viz metadata in analytics json.
  if (/^analytics_/.test(id)) {
    var vizName = $elem.attr("data-viz");
    // If no corresponding metadata found, just return. 
    if (!viz.vizs[vizName]) {
      return;
    }
    analyticsName = viz.name;
    viz = viz.vizs[vizName].metadata;
  }
  
  if (VizUtil.isPivot(viz.options.marker)) {
      // do nothing.
  } else if (VizUtil.isLeaflet(viz.options.marker)) {
    var map = window._leaflet_map_objs[id];
    var options = {
      exclude: ['.leaflet-control-zoom', '.leaflet-control-attribution', '.info-box'],
      format: 'image/png'
    };
    return map.export(options)
    .then(function(res) {
      window._datauris[id] = res ? res.data : "null";
      window.parent.postMessage(JSON.stringify({action:'SnapshotReady', datauris: window._datauris}),'*');
      return null;
    })
    .catch(function(e){
      window._datauris[id] = "null";
      window.parent.postMessage(JSON.stringify({action:'SnapshotReady', datauris: window._datauris}),'*');
    });
  } else if (VizUtil.isROutput(viz.options.marker)) {
  } else if (VizUtil.isPlotly(viz.options.marker)) {
    // plotly
    var graphDiv = document.querySelector('div[data-id="div-'+id+'"] .js-plotly-plot');
    var origw = graphDiv.clientWidth;
    var origh = graphDiv.scrollHeight;
    var width = 1200; 
    var height = graphDiv.scrollHeight > graphDiv.clientHeight ? width * origh / origw : 800;
    return Plotly.toImage(graphDiv,  {format: "png", width: width, height: height})
    .then(function(res){
      window._datauris[id] = !!res ? res : "null";
      window.parent.postMessage(JSON.stringify({action:'SnapshotReady', datauris: window._datauris}),'*');
    }) 
    .catch(function(e){
      window._datauris[id] = "null";
      window.parent.postMessage(JSON.stringify({action:'SnapshotReady', datauris: window._datauris}),'*');
    });
  }

};

var _processViz = function() {
  
  var $elem = $(this); // This script tag
  var id = $elem.attr("data-id");
  var objectName = $elem.attr("data-object-name");
  // Hide loading placeholer
  // It could match multiple elements if there are same charts.
  $('.viz-loading[data-id="'+id+'"]').hide();
  // Backward compatibility. The rmarkdown renders the old cached data if available.
  $('.viz-rendering-error[id="loading-'+id+'"]').hide();
  
  var lang = document.documentElement.lang || null;
  var viz = window[objectName];
  var vizName = $elem.attr("data-viz");
  var analyticsName = null;

  // If it is analytics, find the viz metadata in analytics json.
  if (/^analytics_/.test(id)) {
    if (viz.vizs[vizName]) {
      analyticsName = viz.name;
      viz = VizUtil.analyticify(viz.vizs[vizName].metadata);
    } else {
      // If no metadata found, just set viz to null. 
      // Usually it shouldn't happen but just in case it happens. #9689
      viz = null;
    }
  }

  var containerWidth = $elem.parent().width();

  // The default body max-width: 782px. 
  // The default body width including margin: 902px (782 + 60(side margin) * 2), 
  var FULL_WIDTH_MARGIN_SIDE = screenWidth > 902 ? 60 : 0;  
  var FULL_HEIGHT_MARGIN_TOP = 10;  

  var isFullHeightMode = false;
  var isFullWidthMode = false;

  // User-specified height
  var userHeightStr = $elem.attr("data-height");
  var userHeight = null;
  if (userHeightStr) {
    if (userHeightStr==="full") {
      isFullHeightMode = true;
      userHeight = screenHeight  - FULL_HEIGHT_MARGIN_TOP;
    } else if (/%$/.test(userHeightStr)) {
      userHeight = parseInt(userHeightStr.replace("%",""));
      userHeight = isNaN(userHeight) ? null : (screenHeight * userHeight / 100) - FULL_HEIGHT_MARGIN_TOP;
    } else {
      userHeight = parseInt(userHeightStr.replace("px",""));
      userHeight = isNaN(userHeight) ? null : userHeight;
    }
  }
  // User-specified width
  var userWidthStr = $elem.attr("data-width");
  var userWidth = null;
  if (userWidthStr) {
    if (userWidthStr==="full") {
      isFullWidthMode = true;
      userWidth = screenWidth - FULL_WIDTH_MARGIN_SIDE*2;
    } else if (/%$/.test(userWidthStr)) {
      userWidth = parseInt(userWidthStr.replace("%",""));
      userWidth = isNaN(userWidth) ? null : (screenWidth * userWidth / 100) - (FULL_WIDTH_MARGIN_SIDE*2);
    } else {
      userWidth = parseInt(userWidthStr.replace("px",""));
      userWidth = isNaN(userWidth) ? null : userWidth;
    }
  }

  // Set the min height. If userHeight is available, just use it. 
  // If not, try to set a rectangle shape. Use landscape mode If the screen is 
  // large enough. If small (mobile case), use portrait mode.
  var minHeight = userHeight || (containerWidth<500 ? containerWidth*8/5 : containerWidth*5/8);

  // Insert a viz canvas div right after the script tag.
  // If there's already a div there (refresh case), do nothing.
  var $div = $('div[data-id="div-'+id+'"]');
  if ($div.length === 0) {
    $div = $("<div>").attr('data-id','div-'+id).css({"min-height":minHeight+"px", "margin-bottom":"38px" }).addClass("viz-container markdown-viz-container")   
    $elem.after($div);
  }
  $div.show();

  // If viz is not available, render no data and exit. 
  if (!viz) {
    $div.height(minHeight);
    VizUtil.renderNoData($div[0], "No chart data found: "+vizName);
    // Mark it as rendered.
    window._vizRenderingStatus[id] = true;  
    return;
  } 
 
  // Add a border to table/pivot
  if ( /^(table|pivot|summarytable)$/.test(viz.options.marker)) {
    $div.css({"border-radius":"3px", "border":"1px solid #f0f0f0", "padding":"0px 0px 0px 4px"});
  }
  // If plotly viz, add white background color to make viz visible on TOC
  // if the viz width="full".
  if (! /^(table|pivot|summarytable|map|maphmap|geojson|easymap)/.test(viz.options.marker)) {
    $div.css({"background-color": "#ffffff"});
  }


  var $trigger = $("<a>").attr({'data-id':'a-'+id, 'data-viz':vizName, 'data-object-name':objectName}).addClass("viz-snapshot-trigger").click(_generateSnapshot);
  $elem.after($trigger);   

  var divWidth  = $div.width(); 
  var divHeight = $div.height();
  var width = userWidth ||  divWidth;
  var height = userHeight || divHeight

  // If no scroll specified for height, not to set hight to let the div 
  // expand to fit the content without the vertical scrollbar. 

  // allow full height setting only if 
  // 1. the viz is either pivot or table, or 
  // 2. plotly chart with repeating.
  var allowFullHeight = !!viz.options.facet || /^(table|pivot|summarytable)$/.test(viz.options.marker);
  if (isFullHeightMode && allowFullHeight) {
    // In case of full height setting, not to specify height. 
  } else if (!userHeight && VizUtil.isROutput(viz.options.marker)) {
    // In case of R-based output chart and hight is not specified explicitly 
    // by user, not to set the height to use the full chart area div width. #14492. 
  } else {
    $div.css({'height': height+'px'});
  }

  $div.css({'width': width+'px'});

  // If the width is given by user, adjust the left margin to locate the viz 
  // in the center. If it is in the full width mode, adjust the margin based 
  // on the screen size. 
  if (isFullWidthMode) {
    $div.css('margin-left', ((-1 * ($div.offset().left - FULL_WIDTH_MARGIN_SIDE)) + 'px'));
  } else if (userWidth && userWidth !== divWidth) {
    $div.css('margin-left', ((userWidth - divWidth) / 2 * -1 ) + 'px');
  }

  // in case of facet, make the viz width a bit smaller for the vert scroll bar. 
  viz.options.width = (!viz.options.facet ? width : width-20);
  viz.options.height= height;

  // Show no data message if data is empty. 
  // Some chart can render its own no data message so bypass for those cases. 
  if (VizUtil.shouldRenderNoData(viz.options.data, viz.options)) {
    // Show the query error message if available.
    VizUtil.renderNoData($div[0], viz.options._lastQueryErrorMessage);
    // Mark it as rendered.
    window._vizRenderingStatus[id] = true;    
    return;
  }

  if (VizUtil.isPivot(viz.options.marker)) {
    // Enable "Full Width" mode #15811.
    viz.options.pivotFullWidthMode = "on";

    // Render pivot table
    PivotTableGenerator.render(viz.options, viz.options.data, $div[0],
      null, null, null, null, null, null, null, lang);
    // adjust height 
    var pTitleHeight = $div.find('.pivot-title').outerHeight(true); 
    if ($div.find('.pivot-title').hasClass("hidden")) {
      pTitleHeight = 0;
    }
    var pColTitleHeight = $div.find('.pivot-col-title').outerHeight(true);
    if ($div.find('.pivot-col-title').hasClass("hidden")) {
      pColTitleHeight = 0;
    }
    var pHeaderHeight = $div.find('.pivot-table-frame.pivot-table-col-header-frame').outerHeight();
    var pBodyHeight = $div.find('.pivot-table-frame.pivot-table-body-frame').outerHeight();
    var horizScrollBarHeight = 18;
    var pHeight = pTitleHeight + pColTitleHeight + pHeaderHeight + pBodyHeight + horizScrollBarHeight;
    //console.log(pTitleHeight + " " +pColTitleHeight + " " + pHeaderHeight + " " + pBodyHeight + " " + pHeight + " " + $div.height())
    if (viz.options.marker==="singlevalue"){
      $div.css({'height':'120px', 'min-height':'120px'});
    } else if (pHeight < $div.height()) {
      $div.css({"height": (pHeight)+'px', "min-height":""});
    }

  } else if (VizUtil.isLeaflet(viz.options.marker)) {
    // Render leaflet map
    switch (viz.options.marker) {
      case 'map':
      case 'maphmap':
        $div.parent().parent().css({"background-color":"#fff"});
        MapGenerator.render(viz.options, viz.options.data, $div[0], 
        null, null, null, null, null, null, null, lang);
        break;
      case 'geojson':
        $div.parent().parent().css({"background-color":"#fff"});
        var geojsonObjectName = 'geojson_' + viz.options.geojson; 
        MapGenerator.render(viz.options, viz.options.data, $div[0], window[geojsonObjectName],
          null, null, null, null, null, null, lang);
        break;
      case 'easymap':
        $div.parent().parent().css({"background-color":"#fff"});
        var geojsonObjectName = 'geojson_' + viz.options.easymapMap; 
        MapGenerator.render(viz.options, viz.options.data, $div[0], window[geojsonObjectName],
          null, null, null, null, null, null, lang);
        break;
      default:
        break;
    }
  } else if (VizUtil.isROutput(viz.options.marker)) {
    // Locate the image in center.
    $div.css({'text-align': 'center'});
    // Render R output
    ROutputGenerator.render(viz.options, {"outputFile": [ "libs/exploratory/layout_output/"+ (analyticsName ? analyticsName+"-" : "") + viz.name+".png"]}, $div[0], true);
  } else if (VizUtil.isPlotly(viz.options.marker)) {
    // Show layout toolbar.
    viz.options.showFacetLayoutTool = "on";    
    // Render plotly graph
    $div.css({"overflow-y":"auto"});
    PlotlyGraphGenerator.render(viz.options, viz.options.data, $div[0], true,
      null, null, null, null, null, null, 
      // Pass dummy function to onPropUpdateCallback to enable toolbar.
      function(e){ return false; }, 
      lang);
  }

  // Mark it as rendered.
  window._vizRenderingStatus[id] = true;
  enableLinks();
  window.parent.postMessage(JSON.stringify({action:'SetRenderingStatus', renderingStatus: window._vizRenderingStatus}),'*');
}

// Track the viz rendering status. 
window._vizRenderingStatus = {};

// Render charts.
window._renderViz = function(){
  $vizs.each(function(index) {
    window._vizRenderingStatus[$(this).attr("data-id")] = false;
    setTimeout(_processViz.bind(this) ,50);
  });
};

// Show loading messages on charts. 
window._showLoading = function(){
  $vizs.each(function(index) {
    var dataId = $(this).attr("data-id");
    $('.viz-loading[data-id="'+dataId+'"]').show();
    $('div[data-id="div-'+dataId+'"]').hide();
  });
};

// Reload chart metadata. Used in Interactive mode.
window._reloadMetadata = function(baseUrl){
  var cb = "?cb=" + Date.now();
  $vizs.each(function(index) {
    var analyticsId = $(this).attr("data-analysis"),
      vizId = $(this).attr("data-viz"),
      url = "";
    if (analyticsId) {
      url = baseUrl+"/note_content/libs/exploratory/analytics/"+analyticsId+".js" + cb;
    } else {
      url = baseUrl+"/note_content/libs/exploratory/layout/"+vizId+".js" + cb;
    }
    $(document.body).append('<script src="'  + url +'" />');
  });
};

// Render charts at loading time. 
window._renderViz();


</script>
<!-- END: Exploratory custom footer -->


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>


</body>
</html>
